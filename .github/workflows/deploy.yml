name: Build & Deploy Backend Container

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
       
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
       
      - name: Build backend Docker image
        run: |
          IMAGE_NAME_LOWER=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest" | tr '[:upper:]' '[:lower:]')
          cd Backend
          docker build -t "$IMAGE_NAME_LOWER" .
          docker push "$IMAGE_NAME_LOWER"

  deploy-backend-runpod:
      needs: build-and-push
      runs-on: ubuntu-latest
      
      steps:
        - name: Update backend container on RunPod
          run: |
            set -e
            
            IMAGE_NAME_LOWER=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest" | tr '[:upper:]' '[:lower:]')
            echo "Using image: $IMAGE_NAME_LOWER"
            
            RUNPOD_API_BASE="https://api.runpod.ai/v2/k8s/pod"
            POD_ID="${{ secrets.RUNPOD_BACKEND_POD_ID }}"
            
            echo "Checking current pod status..."
            CURRENT_STATUS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              "$RUNPOD_API_BASE/$POD_ID")
            echo "Current status: $CURRENT_STATUS"
            
            echo "Stopping pod..."
            STOP_RESPONSE=$(curl -s --request POST \
              --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              "$RUNPOD_API_BASE/$POD_ID/stop")
            echo "Stop response: $STOP_RESPONSE"
            
            echo "Waiting for pod to stop..."
            for i in {1..12}; do
              sleep 5
              STATUS_JSON=$(curl -s \
                --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
                "$RUNPOD_API_BASE/$POD_ID")
              
              DESIRED_STATUS=$(echo "$STATUS_JSON" | jq -r '.desiredStatus // "unknown"')
              echo "Attempt $i: desiredStatus=$DESIRED_STATUS"
              
              if [ "$DESIRED_STATUS" = "EXITED" ] || [ "$DESIRED_STATUS" = "STOPPED" ]; then
                echo "Pod stopped successfully"
                break
              fi
              
              if [ $i -eq 12 ]; then
                echo "Warning: Pod may not have stopped completely, continuing anyway..."
              fi
            done
            
            echo "Updating pod configuration..."
            UPDATE_RESPONSE=$(curl -s --request PATCH \
              --url "$RUNPOD_API_BASE/$POD_ID" \
              --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              --header "Content-Type: application/json" \
              --data "{
                \"imageName\": \"$IMAGE_NAME_LOWER\",
                \"gpuTypeId\": \"NVIDIA RTX A5000\",
                \"containerDiskInGb\": 30,
                \"ports\": \"8000/http\",
                \"env\": [
                  {\"key\": \"NVIDIA_VISIBLE_DEVICES\", \"value\": \"all\"},
                  {\"key\": \"APP_NAME\", \"value\": \"Hot's POD\"},
                  {\"key\": \"DEBUG\", \"value\": \"False\"},
                  {\"key\": \"DATABASE_HOST\", \"value\": \"127.0.0.1\"},
                  {\"key\": \"DATABASE_PORT\", \"value\": \"3306\"},
                  {\"key\": \"DATABASE_USER\", \"value\": \"${{ secrets.DATABASE_USER }}\"},
                  {\"key\": \"DATABASE_PASSWORD\", \"value\": \"${{ secrets.DATABASE_PASSWORD }}\"},
                  {\"key\": \"DATABASE_NAME\", \"value\": \"hots_pod_db\"},
                  {\"key\": \"JWT_SECRET_KEY\", \"value\": \"${{ secrets.JWT_SECRET_KEY }}\"},
                  {\"key\": \"JWT_ALGORITHM\", \"value\": \"HS256\"},
                  {\"key\": \"JWT_ACCESS_TOKEN_EXPIRE_MINUTES\", \"value\": \"30\"},
                  {\"key\": \"KAKAO_REST_API_KEY\", \"value\": \"${{ secrets.KAKAO_REST_API_KEY }}\"},
                  {\"key\": \"KAKAO_REDIRECT_URI\", \"value\": \"${{ secrets.KAKAO_REDIRECT_URI }}\"},
                  {\"key\": \"KAKAO_CLIENT_SECRET\", \"value\": \"${{ secrets.KAKAO_CLIENT_SECRET }}\"},
                  {\"key\": \"FRONTEND_URL\", \"value\": \"${{ secrets.FRONTEND_URL }}\"},
                  {\"key\": \"LOCAL_LLM_MODEL_NAME\", \"value\": \"K-intelligence/Midm-2.0-Mini-Instruct\"},
                  {\"key\": \"EMBEDDING_MODEL_NAME\", \"value\": \"jhgan/ko-sroberta-multitask\"},
                  {\"key\": \"FEATURE_RAG_ENABLED\", \"value\": \"True\"},
                  {\"key\": \"CHROMA_DB_PATH\", \"value\": \"/workspace/chroma_db_data\"},
                  {\"key\": \"REDIS_ENABLED\", \"value\": \"False\"},
                  {\"key\": \"CORS_ORIGINS\", \"value\": \"*\"},
                  {\"key\": \"INIT_DB\", \"value\": \"true\"}
                ],
                \"volumeInGb\": 50,
                \"volumeMountPath\": \"/workspace\"
              }")
            echo "Update response: $UPDATE_RESPONSE"
            
            if echo "$UPDATE_RESPONSE" | jq -e '.id // .podId' > /dev/null; then
              echo "Pod updated successfully"
            else
              echo "Error: Pod update may have failed"
              echo "Response: $UPDATE_RESPONSE"
            fi
            
            echo "Starting pod..."
            START_RESPONSE=$(curl -s --request POST \
              --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              "$RUNPOD_API_BASE/$POD_ID/start")
            echo "Start response: $START_RESPONSE"
            
            echo "Waiting for pod to start..."
            for i in {1..24}; do
              sleep 5
              STATUS_JSON=$(curl -s \
                --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
                "$RUNPOD_API_BASE/$POD_ID")
              
              DESIRED_STATUS=$(echo "$STATUS_JSON" | jq -r '.desiredStatus // "unknown"')
              echo "Attempt $i: desiredStatus=$DESIRED_STATUS"
              
              if [ "$DESIRED_STATUS" = "RUNNING" ]; then
                echo "Pod started successfully"
                
                POD_URL=$(echo "$STATUS_JSON" | jq -r '.urls.connect // "N/A"')
                echo "Pod URL: $POD_URL"
                break
              fi
              
              if [ $i -eq 24 ]; then
                echo "Warning: Pod may not have started properly"
                echo "Final status: $STATUS_JSON"
                exit 1
              fi
            done
            
            echo "Deployment completed successfully!"
            
            echo "Final pod information:"
            curl -s \
              --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              "$RUNPOD_API_BASE/$POD_ID" | jq '.'
